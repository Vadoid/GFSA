{% extends 'base.html' %}

{% block title %}{{ data.startup.name }} - Analysis{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="/">Home</a></li>
                <li class="breadcrumb-item active" aria-current="page">{{ data.startup.name }}</li>
            </ol>
        </nav>
        <h1 class="section-title">{{ data.startup.name }}</h1>
        <div class="d-flex justify-content-between mb-4">
            <div>
                <span class="badge bg-primary me-2">{{ data.startup.industry }}</span>
                <span class="badge bg-secondary">{{ data.startup.country }}</span>
            </div>
            {% if data.startup.website %}
            <a href="{{ data.startup.website }}" target="_blank" class="btn btn-outline-primary btn-sm">Visit Website</a>
            {% endif %}
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-8">
        <div class="card mb-4">
            <div class="card-header">
                <h4>Executive Summary</h4>
            </div>
            <div class="card-body">
                <dl>
                    {% for key, value in data.analysis.analysis["1. EXECUTIVE SUMMARY"].items() %}
                    <dt>{{ key }}</dt>
                    <dd>{{ value }}</dd>
                    {% endfor %}
                </dl>
            </div>
        </div>

        <div class="card mb-4">
            <div class="card-header">
                <h4>SWOT Analysis</h4>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h5 class="text-primary">Strengths</h5>
                        <ul>
                            {% for item in data.analysis.analysis["10. SWOT ANALYSIS"]["Core Strengths"] %}
                            <li>{{ item }}</li>
                            {% endfor %}
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <h5 class="text-danger">Weaknesses</h5>
                        <ul>
                            {% for item in data.analysis.analysis["10. SWOT ANALYSIS"]["Primary Weaknesses"] %}
                            <li>{{ item }}</li>
                            {% endfor %}
                        </ul>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-md-6">
                        <h5 class="text-success">Opportunities</h5>
                        <ul>
                            {% for item in data.analysis.analysis["10. SWOT ANALYSIS"]["Key Opportunities"] %}
                            <li>{{ item }}</li>
                            {% endfor %}
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <h5 class="text-warning">Threats</h5>
                        <ul>
                            {% for item in data.analysis.analysis["10. SWOT ANALYSIS"]["Critical Threats"] %}
                            <li>{{ item }}</li>
                            {% endfor %}
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <div class="accordion" id="analysisAccordion">
            {% for section_id, section_data in data.analysis.analysis.items() %}
                {% if section_id not in ["1. EXECUTIVE SUMMARY", "10. SWOT ANALYSIS"] %}
                <div class="accordion-item">
                    <h2 class="accordion-header" id="heading{{ loop.index }}">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse{{ loop.index }}" aria-expanded="false" aria-controls="collapse{{ loop.index }}">
                            {{ section_id }}
                        </button>
                    </h2>
                    <div id="collapse{{ loop.index }}" class="accordion-collapse collapse" aria-labelledby="heading{{ loop.index }}" data-bs-parent="#analysisAccordion">
                        <div class="accordion-body">
                            <dl>
                                {% for key, value in section_data.items() %}
                                <dt>{{ key }}</dt>
                                <dd>
                                    {% if value is string %}
                                        {{ value }}
                                    {% elif value is iterable %}
                                        <ul>
                                            {% for item in value %}
                                            <li>{{ item }}</li>
                                            {% endfor %}
                                        </ul>
                                    {% endif %}
                                </dd>
                                {% endfor %}
                            </dl>
                        </div>
                    </div>
                </div>
                {% endif %}
            {% endfor %}
        </div>
    </div>
    <div class="col-md-4">
        <div class="card sticky-top" style="top: 20px;">
            <div class="card-header">
                <h4>Chat with AI Assistant</h4>
            </div>
            <div class="card-body">
                <div class="chat-container" id="chatContainer">
                    <div class="chat-message bot-message">
                        Hello! I'm your startup analysis assistant. Ask me anything about {{ data.startup.name }} or any other startup in our database.
                    </div>
                </div>
                <div class="input-group">
                    <input type="text" id="chatInput" class="form-control" placeholder="Type your question here...">
                    <button class="btn btn-primary" id="sendButton">Send</button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const chatContainer = document.getElementById('chatContainer');
        const chatInput = document.getElementById('chatInput');
        const sendButton = document.getElementById('sendButton');

        function addMessage(message, isUser) {
            const messageDiv = document.createElement('div');
            messageDiv.className = isUser ? 'chat-message user-message' : 'chat-message bot-message';
            messageDiv.textContent = message;
            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        async function sendMessage() {
            const message = chatInput.value.trim();
            if (!message) return;

            // Add user message to chat
            addMessage(message, true);
            chatInput.value = '';

            // Add loading message
            const loadingDiv = document.createElement('div');
            loadingDiv.className = 'chat-message bot-message';
            loadingDiv.textContent = 'Thinking...';
            chatContainer.appendChild(loadingDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;

            try {
                // Send to API
                const response = await axios.post('/api/chat', {
                    query: message,
                    startup_name: '{{ name }}'
                });

                // Remove loading message
                chatContainer.removeChild(loadingDiv);

                // Add bot response
                addMessage(response.data.response, false);
            } catch (error) {
                // Remove loading message
                chatContainer.removeChild(loadingDiv);
                
                // Add error message
                addMessage('Sorry, I encountered an error. Please try again.', false);
                console.error('Chat error:', error);
            }
        }

        // Event listeners
        sendButton.addEventListener('click', sendMessage);
        chatInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });
    });
</script>
{% endblock %} 