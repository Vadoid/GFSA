<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Startup Details</title>
    <link href="https://fonts.googleapis.com/css2?family=Google+Sans:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        :root {
            --primary-color: #1a73e8;
            --secondary-color: #185abc;
            --background-color: #ffffff;
            --card-background: #ffffff;
            --text-primary: #202124;
            --text-secondary: #5f6368;
            --border-color: #dadce0;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Google Sans', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
        }

        body {
            background-color: var(--background-color);
            color: var(--text-primary);
            line-height: 1.5;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 1.5rem;
        }

        .logo-container {
            padding: 1rem 0 0.5rem;
            max-width: 200px;
        }

        .logo-container img {
            width: 100%;
            height: auto;
            opacity: 0.95;
            transition: opacity 0.2s ease;
        }

        .logo-container img:hover {
            opacity: 1;
        }

        .header {
            margin-bottom: 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-buttons {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .header h1 {
            color: var(--text-primary);
            font-size: 2rem;
            font-weight: 400;
            letter-spacing: -0.5px;
        }

        .back-button {
            padding: 0.75rem 1.25rem;
            background-color: var(--primary-color);
            color: white;
            border-radius: 8px;
            text-decoration: none;
            font-weight: 500;
            transition: background-color 0.2s;
            font-size: 0.9375rem;
        }

        .back-button:hover {
            background-color: var(--secondary-color);
        }

        .generate-report-button {
            padding: 0.75rem 1.25rem;
            background-color: #1e8e3e;
            color: white;
            border-radius: 8px;
            text-decoration: none;
            font-weight: 500;
            transition: background-color 0.2s;
            font-size: 0.9375rem;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .generate-report-button:hover {
            background-color: #137333;
        }

        .generate-report-button:disabled {
            background-color: var(--text-secondary);
            cursor: not-allowed;
        }

        .grid-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .detail-card {
            background: var(--card-background);
            border-radius: 16px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
        }

        .detail-card:hover {
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            border-color: transparent;
        }

        .section-title {
            font-size: 1.125rem;
            font-weight: 500;
            color: var(--text-primary);
            margin-bottom: 1rem;
            padding-bottom: 0.375rem;
            border-bottom: 1px solid var(--border-color);
        }

        .detail-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }

        .detail-item {
            margin-bottom: 0.75rem;
        }

        .detail-label {
            font-weight: 500;
            color: var(--text-secondary);
            margin-bottom: 0.125rem;
            display: block;
            font-size: 0.8125rem;
        }

        .list-item {
            margin-bottom: 0.25rem;
            padding-left: 1rem;
            position: relative;
            font-size: 0.875rem;
            line-height: 1.4;
        }

        .list-item::before {
            content: "•";
            position: absolute;
            left: 0;
            color: var(--primary-color);
        }

        .detail-value {
            color: var(--text-primary);
            line-height: 1.4;
            font-size: 0.875rem;
        }

        .detail-value .list-item:last-child {
            margin-bottom: 0;
        }

        .error {
            background: #fce8e6;
            color: #c5221f;
            padding: 1.25rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            font-size: 0.9375rem;
            border: 1px solid rgba(197, 34, 31, 0.2);
        }

        .founder-card {
            background: var(--card-background);
            border-radius: 8px;
            padding: 1.25rem;
            margin-bottom: 1rem;
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
        }

        .founder-card:hover {
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            border-color: transparent;
        }

        .sub-section {
            margin-top: 0.75rem;
            padding-top: 0.75rem;
            border-top: 1px solid var(--border-color);
        }

        .sub-section .detail-label {
            margin-bottom: 0.25rem;
        }

        .sub-section .detail-value {
            margin-bottom: 0.25rem;
        }

        .sub-title {
            font-weight: 500;
            color: var(--text-primary);
            margin-bottom: 0.75rem;
            font-size: 0.9375rem;
        }

        .ai-analysis-card {
            background: linear-gradient(145deg, #ffffff 0%, #f8f9fa 100%);
            border-radius: 16px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
        }

        .ai-analysis-card:hover {
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            border-color: transparent;
        }

        .ai-badge {
            display: inline-flex;
            align-items: center;
            background: rgba(26, 115, 232, 0.1);
            color: var(--primary-color);
            padding: 0.375rem 0.75rem;
            border-radius: 16px;
            font-size: 0.875rem;
            font-weight: 500;
            margin-bottom: 1rem;
        }

        .ai-badge::before {
            content: "⚡";
            margin-right: 0.5rem;
        }

        .follow-up-list {
            list-style: none;
            padding: 0;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .follow-up-item {
            display: flex;
            gap: 0.75rem;
            padding: 1rem;
            background: white;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
        }

        .follow-up-item:hover {
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            border-color: transparent;
        }

        .follow-up-icon {
            flex-shrink: 0;
            width: 24px;
            height: 24px;
            color: var(--primary-color);
        }

        .follow-up-icon.technical {
            color: #1e8e3e;  /* Google green */
        }

        .follow-up-icon.business {
            color: #1a73e8;  /* Google blue */
        }

        .follow-up-content {
            flex-grow: 1;
        }

        .follow-up-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .follow-up-title {
            font-weight: 500;
            color: var(--text-primary);
            font-size: 1rem;
            margin-right: auto;
        }

        .follow-up-tag {
            display: inline-flex;
            align-items: center;
            padding: 0.25rem 0.75rem;
            border-radius: 16px;
            font-size: 0.75rem;
            font-weight: 500;
            background: #f1f3f4;
            color: var(--text-secondary);
        }

        .follow-up-tag.technical {
            background: rgba(30, 142, 62, 0.1);
            color: #1e8e3e;
        }

        .follow-up-tag.business {
            background: rgba(26, 115, 232, 0.1);
            color: #1a73e8;
        }

        .follow-up-tag.high {
            background: rgba(217, 48, 37, 0.1);
            color: #d93025;
        }

        .follow-up-tag.medium {
            background: rgba(251, 188, 4, 0.1);
            color: #f29900;
        }

        .follow-up-description {
            color: var(--text-secondary);
            font-size: 0.875rem;
            line-height: 1.5;
            margin-bottom: 0.75rem;
        }

        .follow-up-points {
            list-style: none;
            padding: 0;
            margin: 0;
            display: flex;
            flex-direction: column;
            gap: 0.375rem;
        }

        .follow-up-point {
            color: var(--text-secondary);
            font-size: 0.875rem;
            padding-left: 1.25rem;
            position: relative;
            line-height: 1.5;
        }

        .follow-up-point::before {
            content: "•";
            position: absolute;
            left: 0.25rem;
            color: var(--primary-color);
        }

        .chat-container {
            background: var(--card-background);
            border-radius: 16px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
        }

        .chat-container:hover {
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            border-color: transparent;
        }

        .chat-header {
            display: flex;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border-color);
        }

        .chat-title {
            font-size: 1.25rem;
            font-weight: 500;
            color: var(--text-primary);
        }

        .chat-messages {
            max-height: 400px;
            overflow-y: auto;
            margin-bottom: 1rem;
            padding: 1rem;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }

        .message {
            margin-bottom: 0.75rem;
            padding: 0.75rem 1rem;
            border-radius: 8px;
            line-height: 1.5;
            font-size: 0.9375rem;
        }

        .user-message {
            background: #f1f3f4;
            margin-left: 2rem;
            color: var(--text-primary);
        }

        .assistant-message {
            background: #e8f0fe;
            margin-right: 2rem;
            color: var(--text-primary);
        }

        .chat-input-container {
            display: flex;
            gap: 1rem;
            padding: 1rem;
            background: white;
            border-top: 1px solid var(--border-color);
            position: sticky;
            bottom: 0;
        }

        .chat-input {
            flex-grow: 1;
            padding: 0.75rem 1rem;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 0.9375rem;
            resize: none;
            min-height: 2.5rem;
            max-height: 10rem;
            overflow-y: auto;
            background: #f8f9fa;
        }

        .chat-input:focus {
            outline: none;
            border-color: var(--primary-color);
            background: white;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
        }

        .chat-submit {
            padding: 0.75rem 1.5rem;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.9375rem;
        }

        .chat-submit:hover {
            background-color: var(--secondary-color);
        }

        .chat-submit:disabled {
            background-color: var(--text-secondary);
            cursor: not-allowed;
        }

        footer {
            text-align: center;
            padding: 2rem;
            color: var(--text-secondary);
            font-size: 0.875rem;
            border-top: 1px solid var(--border-color);
            margin-top: 3rem;
        }

        footer a {
            color: var(--primary-color);
            text-decoration: none;
        }

        footer a:hover {
            text-decoration: underline;
        }

        @media print {
            body {
                padding: 0;
                margin: 0;
                background: white;
            }

            .container {
                max-width: none;
                margin: 0;
                padding: 1.5rem;
            }

            .header {
                margin-bottom: 2rem;
            }

            .header h1 {
                font-size: 1.5rem;
            }

            .detail-card {
                margin-bottom: 1.5rem;
                padding: 1.5rem;
                box-shadow: none;
                border: 1px solid var(--border-color);
                break-inside: avoid;
            }

            .section-title {
                font-size: 1.125rem;
                margin-bottom: 1rem;
            }

            .detail-value {
                font-size: 0.875rem;
            }

            .ai-analysis-card {
                margin-bottom: 2rem;
                padding: 1.5rem;
                border: 1px solid var(--border-color);
                break-inside: avoid;
            }

            .chat-container, .back-button, .generate-report-button {
                display: none;
            }

            .follow-up-item {
                break-inside: avoid;
                border: 1px solid #e5e7eb;
                box-shadow: none;
            }

            .follow-up-tag {
                border: 1px solid currentColor;
                background: none !important;
            }
        }

        .loading-animation {
            display: inline-block;
            width: 50px;
            height: 50px;
            border: 3px solid rgba(26, 115, 232, 0.2);
            border-radius: 50%;
            border-top-color: var(--primary-color);
            animation: spin 1s ease-in-out infinite;
            margin: 1rem auto;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="logo-container">
            <img src="gfsa.png" alt="Google for Startups" />
        </div>
        <div class="header">
            <h1>Loading...</h1>
            <div class="header-buttons">
                <a href="index.html" class="back-button">← Back to List</a>
                <button id="generateReportButton" class="generate-report-button">Generate Report</button>
            </div>
        </div>
        <div id="aiAnalysisContainer">
            <div class="loading-animation"></div>
        </div>
        <div class="chat-container">
            <div class="chat-header">
                <div class="chat-title">Ment-hoff the AI assistant</div>
            </div>
            <div id="chatMessages" class="chat-messages"></div>
            <div class="chat-input-container">
                <input type="text" id="chatInput" class="chat-input" placeholder="Ask me anything about this startup..." />
                <button id="chatSubmit" class="chat-submit">Send</button>
            </div>
        </div>
        <div id="detailsContainer">
            <div class="loading">Loading...</div>
        </div>
    </div>

    <script>
        async function loadStartupDetails() {
            try {
                const urlParams = new URLSearchParams(window.location.search);
                const startupName = urlParams.get('startup');
                
                if (!startupName) {
                    throw new Error('No startup specified');
                }

                const response = await fetch('analysis_20250327_084704.json');
                if (!response.ok) {
                    throw new Error(`Could not load analysis file. Please ensure it exists in the root directory.`);
                }
                
                const data = await response.json();
                console.log('Loaded data structure:', JSON.stringify(data, null, 2));
                
                const startup = data.find(s => s.metadata.startup_name === startupName);
                
                if (!startup) {
                    throw new Error(`Startup "${startupName}" not found in the analysis data`);
                }

                // Validate startup data structure
                if (!startup.metadata || !startup.analysis) {
                    console.error('Invalid startup data structure:', startup);
                    throw new Error('Invalid startup data structure - missing required fields');
                }

                // Validate company overview
                if (!startup.analysis.company_overview) {
                    console.error('Missing company overview:', startup.analysis);
                    throw new Error('Invalid startup data - missing company overview');
                }

                displayStartupDetails(startup);
            } catch (error) {
                console.error('Detailed error:', error);
                console.error('Error stack:', error.stack);
                document.getElementById('detailsContainer').innerHTML = `
                    <div class="error">
                        <strong>Error loading startup details</strong><br>
                        ${error.message}<br><br>
                        <small>Debug information:</small><br>
                        <pre style="margin-top: 0.5rem; font-size: 0.8rem; white-space: pre-wrap;">${error.stack}</pre><br>
                        <small>If you just ran the analysis, make sure the file exists at: data/results/analysis_20250327_084704.json</small>
                    </div>
                `;
            }
        }

        function displayStartupDetails(startup) {
            try {
                console.log('Displaying startup details for:', startup.metadata.startup_name);
                const { metadata, analysis } = startup;
                const container = document.getElementById('detailsContainer');
                
                // Update the page title and header
                document.title = metadata.startup_name;
                document.querySelector('.header h1').textContent = metadata.startup_name;

                // Store startup data for report generation and trigger AI analysis
                window.currentStartup = startup;
                generateAIAnalysis(startup);

                // Validate data before rendering
                if (!analysis.company_overview) {
                    throw new Error('Missing company overview data');
                }

                let html = `
                    <div class="grid-container">
                        <!-- Basic Info Card -->
                        <div class="detail-card">
                            <div class="section-title">Basic Information</div>
                            <div class="detail-grid">
                                <div class="detail-item">
                                    <span class="detail-label">Company Name</span>
                                    <div class="detail-value">${metadata.startup_name || 'N/A'}</div>
                                </div>
                                <div class="detail-item">
                                    <span class="detail-label">Industry</span>
                                    <div class="detail-value">${metadata.industry || 'N/A'}</div>
                                </div>
                                <div class="detail-item">
                                    <span class="detail-label">Country</span>
                                    <div class="detail-value">${metadata.country || 'N/A'}</div>
                                </div>
                                <div class="detail-item">
                                    <span class="detail-label">Founded</span>
                                    <div class="detail-value">${analysis.company_overview.founding_date || 'N/A'}</div>
                                </div>
                                <div class="detail-item">
                                    <span class="detail-label">Stage</span>
                                    <div class="detail-value">${analysis.company_overview.company_stage || 'N/A'}</div>
                                </div>
                                <div class="detail-item">
                                    <span class="detail-label">Employees</span>
                                    <div class="detail-value">${analysis.company_overview.employee_count || 'N/A'}</div>
                                </div>
                            </div>
                            <div class="sub-section">
                                <span class="detail-label">Description</span>
                                <div class="detail-value">${analysis.company_overview.description || 'No description available'}</div>
                            </div>
                        </div>
                `;

                // Only add sections if they exist and have data
                if (analysis.company_overview.founders && analysis.company_overview.founders.length > 0) {
                    html += `
                        <!-- Founders Section -->
                        <div class="detail-card">
                            <div class="section-title">Founders</div>
                            <div class="founders-container">
                                ${renderFounders(analysis.company_overview.founders)}
                            </div>
                        </div>
                    `;
                }

                if (analysis.product_analysis) {
                    html += `
                        <!-- Product Analysis Card -->
                        <div class="detail-card">
                            <div class="section-title">Products</div>
                            ${renderProducts(analysis.product_analysis)}
                        </div>
                    `;
                }

                if (analysis.market_analysis) {
                    html += `
                        <!-- Market Analysis Card -->
                        <div class="detail-card">
                            <div class="section-title">Market Analysis</div>
                            ${renderMarketAnalysis(analysis.market_analysis)}
                        </div>
                    `;
                }

                if (analysis.business_model) {
                    html += `
                        <!-- Business Model Card -->
                        <div class="detail-card">
                            <div class="section-title">Business Model</div>
                            ${renderBusinessModel(analysis.business_model)}
                        </div>
                    `;
                }

                if (analysis.product_analysis?.technology_stack) {
                    html += `
                        <!-- Technology Stack Card -->
                        <div class="detail-card">
                            <div class="section-title">Technology Stack</div>
                            ${renderTechStack(analysis.product_analysis.technology_stack)}
                        </div>
                    `;
                }

                html += '</div>';
                container.innerHTML = html;

            } catch (error) {
                console.error('Error in displayStartupDetails:', error);
                document.getElementById('detailsContainer').innerHTML = `
                    <div class="error">
                        <strong>Error displaying startup details</strong><br>
                        ${error.message}<br><br>
                        <pre style="margin-top: 0.5rem; font-size: 0.8rem; white-space: pre-wrap;">${error.stack}</pre>
                    </div>
                `;
            }
        }

        function renderFounders(founders) {
            if (!founders || founders.length === 0) return '<div class="detail-value">No founder information available</div>';

            return founders.map((founder, index) => `
                <div class="detail-grid">
                    <div class="detail-item">
                        <span class="detail-label">Name</span>
                        <div class="detail-value">${founder.name}</div>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Title</span>
                        <div class="detail-value">${founder.title}</div>
                    </div>
                    ${founder.education && founder.education.length > 0 ? `
                        <div class="detail-item">
                            <span class="detail-label">Education</span>
                            ${renderList(founder.education)}
                        </div>
                    ` : ''}
                    ${founder.work_experience && founder.work_experience.length > 0 ? `
                        <div class="detail-item">
                            <span class="detail-label">Work Experience</span>
                            ${renderList(founder.work_experience)}
                        </div>
                    ` : ''}
                    ${founder.achievements && founder.achievements.length > 0 ? `
                        <div class="detail-item">
                            <span class="detail-label">Achievements</span>
                            ${renderList(founder.achievements)}
                        </div>
                    ` : ''}
                    ${founder.expertise && founder.expertise.length > 0 ? `
                        <div class="detail-item">
                            <span class="detail-label">Expertise</span>
                            ${renderList(founder.expertise)}
                        </div>
                    ` : ''}
                </div>
                ${index < founders.length - 1 ? '<hr style="margin: 1.5rem 0; border: none; border-top: 1px solid var(--border-color);">' : ''}
            `).join('');
        }

        function renderProducts(productAnalysis) {
            if (!productAnalysis || !productAnalysis.main_products) return '<div class="detail-value">No product information available</div>';

            let html = '';
            if (productAnalysis.main_products && productAnalysis.main_products.length > 0) {
                html += productAnalysis.main_products.map((product, index) => `
                    <div class="detail-item">
                        <div class="sub-title">Product ${index + 1}: ${product.name}</div>
                        <div class="detail-value">${product.description}</div>
                        ${product.key_features ? `
                            <div class="sub-section">
                                <span class="detail-label">Key Features</span>
                                ${renderList(product.key_features)}
                            </div>
                        ` : ''}
                        ${product.target_users ? `
                            <div class="sub-section">
                                <span class="detail-label">Target Users</span>
                                <div class="detail-value">${product.target_users}</div>
                            </div>
                        ` : ''}
                        ${product.pricing ? `
                            <div class="sub-section">
                                <span class="detail-label">Pricing</span>
                                <div class="detail-value">${product.pricing}</div>
                            </div>
                        ` : ''}
                    </div>
                `).join('<hr style="margin: 1rem 0; border: none; border-top: 1px solid #e5e7eb;">');
            }

            if (productAnalysis.unique_features) {
                html += `
                    <div class="sub-section">
                        <span class="detail-label">Unique Features</span>
                        ${renderList(productAnalysis.unique_features)}
                    </div>
                `;
            }

            return html;
        }

        function renderMarketAnalysis(marketAnalysis) {
            if (!marketAnalysis) return '<div class="detail-value">No market analysis available</div>';

            let html = '';

            // Market Size
            if (marketAnalysis.market_size) {
                html += `
                    <div class="detail-item">
                        <span class="detail-label">Market Size</span>
                        <div class="detail-value">
                            ${marketAnalysis.market_size.total_addressable_market || 'N/A'}
                        </div>
                    </div>
                    ${marketAnalysis.market_size.growth_rate ? `
                        <div class="detail-item">
                            <span class="detail-label">Growth Rate</span>
                            <div class="detail-value">${marketAnalysis.market_size.growth_rate}</div>
                        </div>
                    ` : ''}
                `;
            }

            // Market Trends
            if (marketAnalysis.market_trends) {
                html += `
                    <div class="sub-section">
                        <span class="detail-label">Market Trends</span>
                        ${renderList(marketAnalysis.market_trends)}
                    </div>
                `;
            }

            // Competitors
            if (marketAnalysis.competitors) {
                html += `
                    <div class="sub-section">
                        <span class="detail-label">Competitors</span>
                        ${renderCompetitors(marketAnalysis.competitors)}
                    </div>
                `;
            }

            // Regulatory Environment
            if (marketAnalysis.regulatory_environment) {
                html += `
                    <div class="sub-section">
                        <span class="detail-label">Regulatory Environment</span>
                        ${renderRegulatoryEnvironment(marketAnalysis.regulatory_environment)}
                    </div>
                `;
            }

            return html;
        }

        function renderBusinessModel(businessModel) {
            try {
                if (!businessModel) return '<div class="detail-value">No business model information available</div>';

                let html = '';

                // Revenue Streams
                if (businessModel.revenue_streams) {
                    html += `
                        <div class="detail-item">
                            <span class="detail-label">Revenue Streams</span>
                            ${renderRevenueStreams(businessModel.revenue_streams)}
                        </div>
                    `;
                }

                // Pricing Strategy
                if (businessModel.pricing_strategy) {
                    html += `
                        <div class="sub-section">
                            <span class="detail-label">Pricing Strategy</span>
                            <div class="detail-value">${businessModel.pricing_strategy.model || ''}</div>
                            ${businessModel.pricing_strategy.price_points ? `
                                <div class="detail-value">
                                    ${renderList(businessModel.pricing_strategy.price_points)}
                                </div>
                            ` : ''}
                        </div>
                    `;
                }

                // Customer Acquisition
                if (businessModel.customer_acquisition) {
                    html += `
                        <div class="sub-section">
                            <span class="detail-label">Customer Acquisition</span>
                            ${renderList(businessModel.customer_acquisition.channels || [])}
                        </div>
                    `;
                }

                // Partnerships
                if (businessModel.partnerships) {
                    html += `
                        <div class="sub-section">
                            <span class="detail-label">Partnerships</span>
                            ${renderPartnerships(businessModel.partnerships)}
                        </div>
                    `;
                }

                return html || '<div class="detail-value">No business model information available</div>';
            } catch (error) {
                console.error('Error rendering business model:', error);
                return `
                    <div class="error">
                        Error rendering business model: ${error.message}
                        <br>
                        <small>Please check the data structure in the console.</small>
                    </div>
                `;
            }
        }

        function renderTechStack(techStack) {
            if (!techStack) return '<div class="detail-value">No technology stack information available</div>';

            let html = '';

            for (const [category, technologies] of Object.entries(techStack)) {
                if (Array.isArray(technologies) && technologies.length > 0) {
                    html += `
                        <div class="detail-item">
                            <span class="detail-label">${category.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}</span>
                            ${renderList(technologies)}
                        </div>
                    `;
                }
            }

            return html;
        }

        function renderList(items) {
            // Handle non-array inputs
            if (!items) return '<div class="detail-value">No data available</div>';
            
            // Convert string to array if it's a single string
            if (typeof items === 'string') {
                items = [items];
            }
            
            // Ensure items is an array
            if (!Array.isArray(items)) {
                console.warn('Expected array for renderList but got:', typeof items, items);
                return '<div class="detail-value">Invalid data format</div>';
            }
            
            if (items.length === 0) return '<div class="detail-value">No data available</div>';
            
            return `
                <div class="detail-value">
                    ${items.map(item => `<div class="list-item">${item}</div>`).join('')}
                </div>
            `;
        }

        function renderCompetitors(competitors) {
            if (!competitors || competitors.length === 0) return '<div class="detail-value">No competitor data available</div>';
            
            return competitors.map(competitor => `
                <div class="detail-value">
                    <strong>${competitor.name}</strong>
                    <div class="detail-value">${competitor.description}</div>
                    <div class="sub-section">
                        <span class="detail-label">Strengths</span>
                        ${renderList(competitor.strengths)}
                    </div>
                    <div class="sub-section">
                        <span class="detail-label">Weaknesses</span>
                        ${renderList(competitor.weaknesses)}
                    </div>
                </div>
            `).join('<hr style="margin: 0.75rem 0; border: none; border-top: 1px solid #e5e7eb;">');
        }

        function renderRevenueStreams(streams) {
            try {
                if (!streams) return '<div class="detail-value">No revenue stream data available</div>';
                
                // If streams is a string, wrap it in an array
                if (typeof streams === 'string') {
                    streams = [{ type: 'Revenue Stream', description: streams }];
                }
                
                // If streams is not an array, convert it to array format
                if (!Array.isArray(streams)) {
                    console.warn('Revenue streams is not an array:', streams);
                    if (typeof streams === 'object') {
                        streams = [streams];
                    } else {
                        return '<div class="detail-value">Invalid revenue stream data format</div>';
                    }
                }
                
                if (streams.length === 0) return '<div class="detail-value">No revenue stream data available</div>';
                
                return streams.map(stream => `
                    <div class="detail-value">
                        <strong>${stream.type || 'Revenue Stream'}</strong>
                        <div class="detail-value">${stream.description || ''}</div>
                        ${stream.contribution ? `<div class="detail-value"><strong>Contribution:</strong> ${stream.contribution}</div>` : ''}
                        ${stream.growth_potential ? `<div class="detail-value"><strong>Growth Potential:</strong> ${stream.growth_potential}</div>` : ''}
                    </div>
                `).join('<hr style="margin: 0.75rem 0; border: none; border-top: 1px solid #e5e7eb;">');
            } catch (error) {
                console.error('Error rendering revenue streams:', error);
                return '<div class="error">Error rendering revenue streams</div>';
            }
        }

        function renderRegulatoryEnvironment(regulatory) {
            if (!regulatory) return '';

            let html = '';
            
            if (regulatory.current_regulations) {
                html += `
                    <div class="detail-value">
                        <span class="sub-title">Current Regulations</span>
                        ${renderList(regulatory.current_regulations)}
                    </div>
                `;
            }

            if (regulatory.upcoming_changes) {
                html += `
                    <div class="detail-value">
                        <span class="sub-title">Upcoming Changes</span>
                        ${renderList(regulatory.upcoming_changes)}
                    </div>
                `;
            }

            if (regulatory.compliance_requirements) {
                html += `
                    <div class="detail-value">
                        <span class="sub-title">Compliance Requirements</span>
                        ${renderList(regulatory.compliance_requirements)}
                    </div>
                `;
            }

            return html;
        }

        function renderPartnerships(partnerships) {
            try {
                if (!partnerships) return '<div class="detail-value">No partnership data available</div>';
                
                // If partnerships is a string, wrap it in an array
                if (typeof partnerships === 'string') {
                    partnerships = [{ partner: 'Partner', description: partnerships }];
                }
                
                // If partnerships is not an array, convert it to array format
                if (!Array.isArray(partnerships)) {
                    console.warn('Partnerships is not an array:', partnerships);
                    if (typeof partnerships === 'object') {
                        partnerships = [partnerships];
                    } else {
                        return '<div class="detail-value">Invalid partnerships data format</div>';
                    }
                }
                
                if (partnerships.length === 0) return '<div class="detail-value">No partnership data available</div>';
                
                return partnerships.map(partnership => `
                    <div class="detail-value">
                        <strong>${partnership.partner || 'Partner'}</strong>
                        ${partnership.type ? `<div class="detail-value"><strong>Type:</strong> ${partnership.type}</div>` : ''}
                        ${partnership.benefits ? `
                            <div class="detail-value">
                                <span class="sub-title">Benefits</span>
                                ${renderList(partnership.benefits)}
                            </div>
                        ` : ''}
                        ${partnership.status ? `<div class="detail-value"><strong>Status:</strong> ${partnership.status}</div>` : ''}
                    </div>
                `).join('<hr style="margin: 0.75rem 0; border: none; border-top: 1px solid #e5e7eb;">');
            } catch (error) {
                console.error('Error rendering partnerships:', error);
                return '<div class="error">Error rendering partnerships</div>';
            }
        }

        async function generateAIAnalysis(startup) {
            const { metadata, analysis } = startup;
            
            // Show loading state
            document.getElementById('aiAnalysisContainer').innerHTML = `
                <div class="ai-analysis-card">
                    <div class="ai-badge">AI Analysis in Progress</div>
                    <div class="loading-animation"></div>
                </div>
            `;
            
            // Prepare the data for the API
            const analysisData = {
                startup_name: metadata.startup_name,
                industry: metadata.industry,
                country: metadata.country,
                description: analysis.company_overview.description,
                product_info: analysis.product_analysis,
                market_info: analysis.market_analysis,
                business_model: analysis.business_model
            };

            try {
                console.log('Preparing to send data to API:', {
                    url: 'http://localhost:5000/api/analyze-startup',
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    data: analysisData
                });
                
                const response = await fetch('http://localhost:5000/api/analyze-startup', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify(analysisData)
                });

                console.log('Received response:', {
                    status: response.status,
                    statusText: response.statusText,
                    headers: Object.fromEntries(response.headers.entries())
                });

                let responseData;
                const contentType = response.headers.get("content-type");
                
                if (contentType && contentType.indexOf("application/json") !== -1) {
                    responseData = await response.json();
                    console.log('Parsed JSON response:', responseData);
                } else {
                    // If response is not JSON, get the text and log it
                    const text = await response.text();
                    console.error('Received non-JSON response:', {
                        contentType,
                        text,
                        status: response.status
                    });
                    throw new Error(`Server returned non-JSON response (${contentType}): ${text}`);
                }

                if (!response.ok) {
                    const errorMessage = responseData.error || responseData.details || `HTTP error! status: ${response.status}`;
                    console.error('Response not OK:', {
                        status: response.status,
                        error: errorMessage,
                        response: responseData
                    });
                    throw new Error(errorMessage);
                }

                displayAIAnalysisResult(responseData);
            } catch (error) {
                console.error('Error in generateAIAnalysis:', error);
                document.getElementById('aiAnalysisContainer').innerHTML = `
                    <div class="error">
                        <strong>Error generating AI analysis</strong><br>
                        ${error.message}<br><br>
                        <pre style="margin-top: 0.5rem; font-size: 0.8rem; white-space: pre-wrap;">${error.stack}</pre>
                    </div>
                `;
            }
        }

        function displayAIAnalysisResult(result) {
            const container = document.getElementById('aiAnalysisContainer');
            container.innerHTML = `
                <div class="ai-analysis-card">
                    <div class="ai-badge">AI-Powered Analysis</div>
                    
                    <div class="section-title">Executive Summary</div>
                    <div class="detail-value" style="margin-bottom: 2rem;">
                        ${result.executive_summary.market_opportunity}<br><br>
                        ${result.executive_summary.competitive_advantage}<br>
                        ${result.executive_summary.growth_trajectory}<br>
                        ${result.executive_summary.risk_assessment}
                    </div>
                    
                    <div class="section-title">Recommended Follow-up Items</div>
                    <ul class="follow-up-list">
                        ${result.follow_up_items.map(item => `
                            <li class="follow-up-item">
                                <div class="follow-up-icon ${item.category.toLowerCase()}">
                                    ${item.category === 'Technical' ? '🔧' : '💼'}
                                </div>
                                <div class="follow-up-content">
                                    <div class="follow-up-header">
                                        <div class="follow-up-title">${item.title}</div>
                                        <div class="follow-up-tag ${item.category.toLowerCase()}">${item.category}</div>
                                        <div class="follow-up-tag ${item.priority.toLowerCase()}">${item.priority}</div>
                                    </div>
                                    <div class="follow-up-description">${item.description}</div>
                                    <ul class="follow-up-points">
                                        ${item.key_points.map(point => `
                                            <li class="follow-up-point">${point}</li>
                                        `).join('')}
                                    </ul>
                                </div>
                            </li>
                        `).join('')}
                    </ul>
                </div>
            `;
        }

        // Initialize chat functionality
        document.addEventListener('DOMContentLoaded', () => {
            const chatInput = document.getElementById('chatInput');
            const chatSubmit = document.getElementById('chatSubmit');
            
            chatSubmit.addEventListener('click', handleChatSubmit);
            chatInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    handleChatSubmit();
                }
            });

            // Initialize the startup details
            loadStartupDetails();
        });

        // Initialize generate report functionality
        document.addEventListener('DOMContentLoaded', () => {
            const generateReportButton = document.getElementById('generateReportButton');
            if (generateReportButton) {
                generateReportButton.addEventListener('click', async () => {
                    const button = generateReportButton;
                    const originalText = button.innerHTML;
                    
                    try {
                        button.disabled = true;
                        button.innerHTML = 'Generating PDF...';
                        
                        const opt = {
                            margin: [5, 5, 5, 5],
                            filename: `${window.currentStartup.metadata.startup_name}_report.pdf`,
                            image: { type: 'jpeg', quality: 0.98 },
                            html2canvas: { 
                                scale: 2,
                                useCORS: true,
                                logging: false
                            },
                            jsPDF: { 
                                unit: 'mm', 
                                format: 'a4', 
                                orientation: 'portrait' 
                            }
                        };

                        await html2pdf().set(opt).from(document.body).save();
                        
                        button.innerHTML = originalText;
                        button.disabled = false;
                        
                        const successMessage = document.createElement('div');
                        successMessage.style.cssText = `
                            position: fixed;
                            bottom: 20px;
                            right: 20px;
                            background: #10b981;
                            color: white;
                            padding: 0.75rem 1.5rem;
                            border-radius: 0.5rem;
                            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                            z-index: 1000;
                            animation: slideIn 0.3s ease-out;
                        `;
                        successMessage.textContent = 'PDF Report Generated Successfully!';
                        document.body.appendChild(successMessage);
                        
                        setTimeout(() => {
                            successMessage.style.animation = 'slideOut 0.3s ease-out';
                            setTimeout(() => successMessage.remove(), 300);
                        }, 3000);
                        
                    } catch (error) {
                        console.error('Error generating PDF:', error);
                        button.innerHTML = originalText;
                        button.disabled = false;
                        
                        const errorMessage = document.createElement('div');
                        errorMessage.style.cssText = `
                            position: fixed;
                            bottom: 20px;
                            right: 20px;
                            background: #ef4444;
                            color: white;
                            padding: 0.75rem 1.5rem;
                            border-radius: 0.5rem;
                            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                            z-index: 1000;
                            animation: slideIn 0.3s ease-out;
                        `;
                        errorMessage.textContent = 'Error generating PDF. Please try again.';
                        document.body.appendChild(errorMessage);
                        
                        setTimeout(() => {
                            errorMessage.style.animation = 'slideOut 0.3s ease-out';
                            setTimeout(() => errorMessage.remove(), 300);
                        }, 3000);
                    }
                });
            }
        });

        // Add animation keyframes
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideIn {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            @keyframes slideOut {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(100%); opacity: 0; }
            }
        `;
        document.head.appendChild(style);

        // Add chat functionality
        async function handleChatSubmit() {
            const input = document.getElementById('chatInput');
            const submit = document.getElementById('chatSubmit');
            const messages = document.getElementById('chatMessages');
            
            const query = input.value.trim();
            if (!query) return;
            
            input.disabled = true;
            submit.disabled = true;
            
            messages.innerHTML += `
                <div class="message user-message">
                    ${query}
                </div>
            `;
            
            try {
                const startup = window.currentStartup;
                
                const response = await fetch('http://localhost:5000/api/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        query,
                        startup_context: startup
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                messages.innerHTML += `
                    <div class="message assistant-message">
                        ${data.response}
                    </div>
                `;
                
                input.value = '';
                
            } catch (error) {
                console.error('Chat error:', error);
                messages.innerHTML += `
                    <div class="message assistant-message" style="background: #fee2e2; color: #991b1b;">
                        Sorry, I encountered an error: ${error.message}
                    </div>
                `;
            } finally {
                input.disabled = false;
                submit.disabled = false;
                input.focus();
                messages.scrollTop = messages.scrollHeight;
            }
        }
    </script>
</body>
</html>